# Introduction
The goal of this POC is to allow:
- admins to configure notifications-types for web-hooks
- customers to read schemas for web-hook notification-types
- admins to configure schemas for web-hook notification-types
- customers to configure the endpoints they want to receive web-hooks at
- customers to configure notification-types they want for each endpoint
- services to send type-safe messages to pub-sub to be relayed to web-hooks
- admins/tests to validate payloads against json schemas 

This first part is command and consumer driven, 
meaning that the message represents an action to be executed,
and that the schema is defined by the consumer (in svix).
This requires that either:
- the consumer sends messages that are expected to fail.
  (if the customer doesn't have an app created in svix)
- the producer checks the app existence before sending the event.
- the event is filtered after being published but before being sent to svix. 
  
The extended scope of this POC is to allow:
- admins to manage schemas for their event types
- events to be mapped to notifications dynamically
- customers to manage their subscribe to notification-types
- admins to manage transformations and links between events and notifications
- customers to manage the emails they want to receve notifications at  

# Components
## WebHooks
### Svix Client
The first thing we need is to be able to call svix, 
fortunately they already provide an sdk based on their open-api.
It requires `SVIX_AUTH_TOKEN` to authenticate our calls towards svix.  
This token can be generated by running the `token` service of docker-compose.  
A sample token exists in docker-compose file, it might need replacing from time to time.  
It can have `SVIX_URL` to configure svix's host, 
if we need to, for example, use it in a containarized service.
### Svix CLI
The second thing we need is to call svix from somewhere,
the most basic interface is a CLI so we created a CLI to call svix. 
It depends on the same environment variables as Svix Client.  
You can set the auth-token as an environment variable by calling `export SVIX_AUTH_TOKEN={token}`  
[TODO: add how to for Svix commands]  
### GRPC API
The first requirement was creating apps and event types, for this we made the feature available through grpc.  
- Manage Apps
- Manage WebHook Schemas
[TODO: add how to for Svix commands]  
### GRPC CLI
To test locally, some call methods were added to the CLI   
[TODO: add how to for WebHooks grpc api]  
### HTTP API
To allow customers to configure their endpoints, for this we made the feature available through http.  
- Read WebHookTypes
- Manage Endpoints
- Read Sent Messages
- Read Message Attempts
### HTTP CLI
To test locally, some call methods were added to the CLI  
### PubSub API
To allow temporal decoupling of the message sending a pubsub subscriber was added.  
### PubSub CLI
To test locally, some call methods were added to the CLI  
## Router
### PubSub API
To allow temporal decoupling of the message sending a pubsub subscriber was added.  
- Transform payloads between topics
- Publish Notifications for Events into common topic
- Publish Commands for Notifications into provider topics 
### Postgres Repo
To allow subscriptions to be configured, we created a repository.
### Postgres CLI
To test locally, some call methods were added to the CLI 
### GRPC API
The first requirement was to create event types, for this we made the feature available through grpc.
- Manage Event Schemas
### GRPC CLI
To test locally, some call methods were added to the CLI 
### HTTP API
To allow customers to configure their subscriptions, for this we made the feature available through http.
- Manage Notification Subscriptions
### HTTP CLI
To test locally, some call methods were added to the CLI 

# Tools
## Docker
In order to test with simulated services, a docker-compose file was created  
## Postgres
## Google PubSub

# Run
- Run `docker-compose up -d` to start the services
- Run `make` to configure them

# Testing
## Automated
- Run `make test`
## Manual
- Get auth-token from `token` docker logs
- Run `export SVIX_AUTH_TOKEN={token}`
- Run `go run . call svix event-type create -n TestEvent`
- Run `go run . call svix app create -n Test` and get App's Id
- Run `export SVIX_APP_ID={app-id}`
- Run `go run . call svix endpoint create -a $SVIX_APP_ID -n Test`
### 1 - CLI Sync WebHook Request
- Run `go run . call svix message create -a $SVIX_APP_ID -p '{ "foo": "bar" }'`
Run service for webhooks and call its grpc
### 2 - Async WebHook Request
Run service for webhooks
- Run `go run . call topic create webhook`
- Run `go run . call svix topic publish webhook -m app=$SVIX_APP_ID -p '{ "foo": "bar" }'`
### 3 - WebHook Request on Subscribed Event
Run service for events and webhooks
- Run `go run . call topic create notification example`
